#!/bin/bash
sleep 1
spam_ver=1.10cb1

pause() {
    prompt="$1"
    echo -e -n "\033[1;36m$prompt"
    echo -e -n '\033[0m'
    read
}

help () {
echo "Usage: spam <operation> [...]"
echo "operations:"
echo "    spam {-h --help}"
echo "    spam {-v --version}"
echo "    spam remove package"
echo "    spam install user/package"
echo "    spam selfupgrade"
echo ""
echo "use 'spam {-h --help}' with an operation for available options"
}

nocommand () {
echo "no command specified or command not found (use spam -h for help)"
exit 1
}

version () {
echo "Spam, Spam PAckage Manager ${spam_ver} by Bashelled"
echo "Backends:"
echo " * BASH version ${BASH_VERSION} by The GNU Project"
echo " * $(git --version) by Git Developers"
echo " * $(tar --version | grep tar) by The GNU Project"
}

updatespam () {
echo "Pulling spam from official mirrors..."
if git -C $HOME/.spam pull; then
	echo "You have installed Spam version ${spam_ver}!"
	echo "See the site for more info"
else
	echo "There was an error updating spam."
	exit 1
fi
}

pkglist () {
ls $HOME/.spam/pkg
}

pkgdel () {
  pkg=$1
   if [ ! -e "$HOME/.spam/pkg/${pkg}" ]; then
     echo "$pkg is not on your computer."
   else
     echo "Removing $1..."
     echo "* Removing symlinks..."
     rm -rf $HOME/.spam/bin/$(ls $HOME/.spam/pkg/$pkg/bin)
     echo "* Removing package box..."
     rm -rf $HOME/.spam/pkg/$pkg
     echo "Done!"
   fi
}

 pkguse () {
  pkg=${1/*\/}
  if [[ -z $1 ]]; then
   echo No command found.
   exit 1
  fi
   if [ -e "$HOME/.spam/pkg/${pkg}" ]; then
     echo "$pkg is already on your computer."
   else
     echo "Installing $1..."
     git clone https://github.com/$1 ~/.spam/usr/pkgcache/$pkg &> /dev/null
     pkgpath="$HOME/.spam/usr/pkgcache/$pkg"
     pkgbox="$HOME/.spam/pkg/$pkg"
     if [[ -f "$pkgpath/$pkg.spk" ]]; then
      echo "* Sourcing metadata..."
      . $pkgpath/metadata.smd
      echo "* Making package box..."
      mkdir -p $pkgbox
      echo "* Extracting spamball and metadata to package box..."
      tar xf $pkgpath/$pkg.spk -C $pkgbox
      cp $pkgpath/metadata.smd $pkgbox
      echo "* Symlinking binarys to ~/.spam/bin..."
      ln -s $pkgbox/bin/* $HOME/.spam/bin
      echo "Deleting cache..."
      rm -rf $pkgpath
      echo "Done!"
     else
       echo "A fatal error occured."
       rm -rf $pkgpath
     fi
   fi
 }

 rkguse () {
  pkg=$2
  repo=$1
  if [[ -z $1 ]]; then
   echo No command found.
   exit 1
  fi
   if [ -e "$HOME/.spam/pkg/${pkg}" ]; then
     echo "$pkg is already on your computer."
   else
     echo "Installing $2 from $1..."
     git clone https://github.com/$1 ~/.spam/usr/pkgcache/repo-${repo/\//-}/$pkg &> /dev/null
     repopath="$HOME/.spam/usr/pkgcache/repo-${repo/\//-}/$pkg"
     pkgbox="$HOME/.spam/pkg/$pkg"
     if [[ -f "$repopath/spam/$pkg.spk" ]]; then
      echo "* Sourcing metadata..."
      . $repopath/spam/$pkg.smd
      echo "* Making package box..."
      mkdir -p $pkgbox
      echo "* Extracting spamball and metadata to package box..."
      tar xf $repopath/spam/$pkg.spk -C $pkgbox
      cp $repopath/spam/$pkg.smd $pkgbox
      echo "* Symlinking binarys to ~/.spam/bin..."
      ln -s $pkgbox/bin/* $HOME/.spam/bin
      echo "* Deleting cache..."
      rm -rf $repopath
      echo "Done!"
     else
       echo "A fatal error occured."
       rm -rf $repopath
     fi
   fi
 }


if [[ "$1" == "-h" || "$1" == "--help" ]]; then
	help
elif [[ "$1" == "-v" || "$1" == "--version" ]]; then
	version
elif [[ "$1" == "remove" ]]; then
	pkgdel $2
elif [[ "$1" == "selfupgrade" ]]; then
	updatespam
elif [[ "$1" == "install" ]]; then
 	pkguse $2
elif [[ "$1" == "list" ]]; then
	pkglist
elif [[ "$1" == "installrepo" ]]; then
        rkguse $2 $3
else
	nocommand
fi
